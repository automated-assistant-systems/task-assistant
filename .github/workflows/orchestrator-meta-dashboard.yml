---
# yamllint disable rule:truthy
name: Orchestrator â€¢ Meta Dashboard Build

on:
  schedule:
    - cron: "0 * * * *"
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  build-meta-dashboard:
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ github.token }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install jq
        run: sudo apt-get install -y jq

      - name: Debug file structure
        run: |
          echo "WORKING DIRECTORY:"
          pwd
          echo "FILE LIST:"
          ls -R .
          echo "CHECKING repos.json:"
          if [ -f "./meta-dashboard/repos.json" ]; then
            echo "repos.json exists."
          else
            echo "ERROR: repos.json is missing!"
          fi

      - name: Build meta-dashboard.json
        run: |
          mkdir -p meta-dashboard

          # Load repository list
          repos=$(jq -c '.repositories[]' "./meta-dashboard/repos.json")

          echo "DEBUG: Parsed repos list:"
          echo "$repos"

          OUTPUT="{\"generated_at\":\"$(date -u +"%Y-%m-%dT%H:%M:%SZ")\","
          OUTPUT="$OUTPUT\"meta_version\":\"1.1.0\",\"repos\":{"

          first_repo=true

          for r in $repos; do
            id=$(echo "$r" | jq -r '.id')
            owner=$(echo "$r" | jq -r '.owner')
            repo=$(echo "$r" | jq -r '.repo')
            workflow=$(echo "$r" | jq -r '.workflow')
            display=$(echo "$r" | jq -r '.display_name')

            # Build workflow API path safely
            WF_PATH="repos/$owner/$repo/actions/workflows/$workflow/runs"

            # Fetch workflow status
            STATUS=$(gh api "$WF_PATH" \
              --jq '.workflow_runs[0].conclusion' \
              2>/dev/null || echo "unknown")

            if [ "$first_repo" = true ]; then
              first_repo=false
            else
              OUTPUT="$OUTPUT,"
            fi

            OUTPUT="$OUTPUT\"$id\":{"
            OUTPUT="$OUTPUT\"repo\":\"$owner/$repo\","
            OUTPUT="$OUTPUT\"display_name\":\"$display\","
            OUTPUT="$OUTPUT\"workflow\":\"$workflow\","
            OUTPUT="$OUTPUT\"status\":\"$STATUS\"}"
          done

          OUTPUT="$OUTPUT}}"

          echo "$OUTPUT" > meta-dashboard/meta-dashboard.json

          echo "FINAL OUTPUT:"
          cat meta-dashboard/meta-dashboard.json

      - name: Commit Dashboard
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Update meta-dashboard.json"
          add_options: '--all'
