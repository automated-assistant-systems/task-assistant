---
name: Task Assistant • Dashboard Build

# yamllint disable rule:truthy
on:
  workflow_dispatch:
  schedule:
    - cron: "15 * * * *"

permissions:
  contents: read
  id-token: write

env:
  TELEMETRY_REPO: ${{ vars.TELEMETRY_REPO }}
  TELEMETRY_PATH: telemetry-repo
  TELEMETRY_ROOT: telemetry-repo/telemetry/v1/repos
  DASHBOARD_ROOT: telemetry-repo/telemetry/v1/dashboards

jobs:
  build_dashboards:
    runs-on: ubuntu-latest

    steps:
      - name: Validate telemetry configuration
        run: |
          if [ -z "${TELEMETRY_REPO}" ]; then
            echo "::error::TELEMETRY_REPO is not set"
            exit 1
          fi

      - name: Checkout Task Assistant (host)
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: npm ci

      # ─────────────────────────────────────────────
      # Generate GitHub App token (same as self-test)
      # ─────────────────────────────────────────────
      - name: Generate GitHub App token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.CODEX_APP_ID }}
          private-key: ${{ secrets.CODEX_PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}

      # ─────────────────────────────────────────────
      # Checkout telemetry repo using app token
      # ─────────────────────────────────────────────
      - name: Checkout telemetry repo
        uses: actions/checkout@v4
        with:
          repository: ${{ env.TELEMETRY_REPO }}
          path: ${{ env.TELEMETRY_PATH }}
          token: ${{ steps.app-token.outputs.token }}
          fetch-depth: 1

      - name: Ensure dashboard root exists
        run: |
          mkdir -p "${DASHBOARD_ROOT}"

      # ─────────────────────────────────────────────
      # Build dashboards (read repos/, write dashboards/)
      # ─────────────────────────────────────────────
      - name: Build dashboards
        run: node scripts/build-dashboards.js

      # ─────────────────────────────────────────────
      # Commit dashboards back to telemetry repo
      # ─────────────────────────────────────────────
      - name: Commit dashboard artifacts
        working-directory: ${{ env.TELEMETRY_PATH }}
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
        run: |
          git config user.name "task-assistant-bot"
          git config user.email "actions@github.com"
          git add telemetry/v1/dashboards
          git commit -m "telemetry(v1): update dashboards" || echo "No dashboard changes"
          git push || echo "No changes to push"
