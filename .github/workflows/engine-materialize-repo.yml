---
name: Task Assistant • Engine • Materialize Repo

# yamllint disable rule:truthy
on:
  workflow_call:
    inputs:
      target_repo:
        description: "Target repository (owner/repo)"
        required: true
        type: string

      telemetry_repo:
        description: "Resolved telemetry repository"
        required: true
        type: string

      correlation_id:
        description: "Run-scoped correlation ID (system-generated)"
        required: true
        type: string

    secrets:
      CODEX_APP_ID:
        required: true
      CODEX_PRIVATE_KEY:
        required: true

permissions:
  contents: write
  issues: write
  id-token: write

jobs:
  materialize:
    runs-on: ubuntu-latest

    env:
      ENGINE_NAME: materialize
      ENGINE_JOB: materialize
      CORRELATION_ID: ${{ inputs.correlation_id }}
      TELEMETRY_REPO: ${{ inputs.telemetry_repo }}

    steps:
      # ─────────────────────────────────────────────
      # Checkout Task Assistant (engine code only)
      # ─────────────────────────────────────────────
      - name: Checkout Task Assistant
        uses: actions/checkout@v4
        with:
          repository: automated-assistant-systems/task-assistant
          ref: main
          path: task-assistant

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        working-directory: task-assistant
        run: |
          set -euo pipefail
          npm ci

      # ─────────────────────────────────────────────
      # Parse target repo
      # ─────────────────────────────────────────────
      - name: Parse target repo
        run: |
          TARGET="${{ inputs.target_repo }}"
          OWNER="${TARGET%%/*}"
          REPO="${TARGET##*/}"

          echo "OWNER=$OWNER" >> "$GITHUB_ENV"
          echo "REPO=$REPO"   >> "$GITHUB_ENV"

      # ─────────────────────────────────────────────
      # Authenticate as GitHub App (target repo)
      # ─────────────────────────────────────────────
      - name: Generate GitHub App token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id:      ${{ secrets.CODEX_APP_ID }}
          private-key: ${{ secrets.CODEX_PRIVATE_KEY }}
          owner:       ${{ env.OWNER }}

      # ─────────────────────────────────────────────
      # Fetch config from target repo
      # ─────────────────────────────────────────────
      - name: Fetch Task Assistant config
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
        run: |
          set -euo pipefail

          gh api "repos/$OWNER/$REPO/contents/.github/task-assistant.yml" \
            --jq '.content' | base64 -d > config.yml

      # ─────────────────────────────────────────────
      # Validate configuration (authoritative)
      # ─────────────────────────────────────────────
      - name: Validate configuration
        working-directory: task-assistant
        run: |
          set -euo pipefail
          node scripts/config/validate-config.js ../config.yml

      # ─────────────────────────────────────────────
      # Materialize labels & milestones
      # ─────────────────────────────────────────────
      - name: Materialize repository metadata
        working-directory: task-assistant
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
          TARGET_REPO: ${ env.OWNER }}/${{ env.REPO }}
          TELEMETRY_REPO: ${{ inputs.telemetry_repo }}
          CORRELATION_ID: ${{ inputs.correlation_id }}
        run: |
          node scripts/engines/materialize-repo.mjs

      # ─────────────────────────────────────────────
      # Emit materialization telemetry
      # ─────────────────────────────────────────────
      - name: Emit materialization telemetry
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
        working-directory: task-assistant
        run: |
          set -euo pipefail

          jq -n \
            --arg repo "$OWNER/$REPO" \
            '{
              ok: true,
              summary: "Repository metadata materialized",
              target_repo: $repo
            }' > result.json

          ENGINE_NAME="materialize" \
          ENGINE_JOB="materialize" \
          TELEMETRY_REPO="$TELEMETRY_REPO" \
          RESULT_FILE="result.json" \
          ../scripts/telemetry/emit-engine.sh
