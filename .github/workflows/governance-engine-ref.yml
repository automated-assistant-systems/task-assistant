---
name: Governance â€¢ Engine Ref Enforcement

# yamllint disable rule:truthy
on:
  pull_request:
    paths:
      - ".github/workflows/**"
  push:
    branches:
      - main
    paths:
      - ".github/workflows/**"

permissions:
  contents: read

jobs:
  enforce:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Engine Ref Governance Check
        shell: bash
        run: |
          set -euo pipefail

          echo "ğŸ” Scanning workflows for governance violations..."

          VIOLATIONS=0

          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          # 1. ref: main is forbidden
          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          if grep -R --line-number "ref:[[:space:]]*main" .github/workflows; then
            echo "âŒ ref: main is forbidden."
            VIOLATIONS=1
          fi

          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          # 2. Direct reusable engine calls must not pin branches
          #    Only immutable tags (vX.Y.Z) allowed on main branch
          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          if [[ "${GITHUB_REF##*/}" == "main" ]]; then
            echo "ğŸ”’ Production branch detected (main)"

            # detect @phase- or @feature- etc
            if grep -R --line-number "@phase-" .github/workflows; then
              echo "âŒ Branch engine refs not allowed on main."
              VIOLATIONS=1
            fi

            if grep -R --line-number "@feature-" .github/workflows; then
              echo "âŒ Feature engine refs not allowed on main."
              VIOLATIONS=1
            fi
          fi

          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          # 3. All reusable engine calls must pass engine_ref input
          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          for file in $(grep -Rl "uses: automated-assistant-systems/task-assistant/.github/workflows/engine-" .github/workflows || true); do
            echo "Checking engine invocation in $file"

            if ! grep -A5 "uses: automated-assistant-systems/task-assistant/.github/workflows/engine-" "$file" | grep -q "engine_ref:"; then
              echo "âŒ $file calls reusable engine but does not pass engine_ref"
              VIOLATIONS=1
            fi
          done

          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          # 4. Engine workflows must accept engine_ref input
          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          for file in .github/workflows/engine-*.yml; do
            if [[ -f "$file" ]]; then
              if ! grep -q "engine_ref:" "$file"; then
                echo "âŒ $file does not define engine_ref input"
                VIOLATIONS=1
              fi

              if ! grep -q "ref: \${{ inputs.engine_ref }}" "$file"; then
                echo "âŒ $file does not use inputs.engine_ref for checkout"
                VIOLATIONS=1
              fi
            fi
          done

          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          # 5. Cron workflows must not rely on floating branch
          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          for file in $(grep -Rl "schedule:" .github/workflows || true); do
            echo "Checking cron workflow: $file"

            if grep -q "@phase-" "$file"; then
              echo "âš ï¸  Cron pinned to branch ref (allowed in dev, forbidden on main)"
            fi

            if [[ "${GITHUB_REF##*/}" == "main" ]]; then
              if grep -q "@phase-" "$file"; then
                echo "âŒ Cron must use immutable tag on main"
                VIOLATIONS=1
              fi
            fi
          done

          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          # Final result
          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          if [[ "$VIOLATIONS" -ne 0 ]]; then
            echo ""
            echo "âŒ Engine Ref Governance FAILED"
            exit 1
          fi

          echo ""
          echo "âœ… Engine Ref Governance PASSED"
