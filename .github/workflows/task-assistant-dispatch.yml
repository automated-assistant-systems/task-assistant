---
name: Task Assistant • Dispatch

# yamllint disable rule:truthy
on:
  # ─────────────────────────────────────────────
  # Manual operator execution (Marketplace-safe)
  # ─────────────────────────────────────────────
  workflow_dispatch:
    inputs:
      target_repo:
        description: "Target repository (owner/repo)"
        required: true
      mode:
        description: "Execution mode"
        required: true
        default: "self-test"
        type: choice
        options:
          - self-test
          - validate
          - enforce

  # ─────────────────────────────────────────────
  # Event-driven triggers (non-destructive by default)
  # ─────────────────────────────────────────────
  issues:
    types: [labeled]

  # ─────────────────────────────────────────────
  # Scheduled diagnostics (read-only)
  # ─────────────────────────────────────────────
  schedule:
    - cron: "0 3 * * *"   # daily diagnostics (UTC)

permissions:
  contents: write
  issues: write
  id-token: write

env:
  CORRELATION_ID: ${{ github.run_id }}-${{ github.run_attempt }}

jobs:
  dispatch:
    runs-on: ubuntu-latest

    steps:
      # ─────────────────────────────────────────────
      # Checkout Task Assistant (host repo)
      # ─────────────────────────────────────────────
      - name: Checkout Task Assistant
        uses: actions/checkout@v4

      # ─────────────────────────────────────────────
      # Resolve target repo + mode
      # ─────────────────────────────────────────────
      - name: Resolve dispatch context
        run: |
          set -euo pipefail

          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            TARGET_REPO="${{ inputs.target_repo }}"
            MODE="${{ inputs.mode }}"
          elif [ "${{ github.event_name }}" = "issues" ]; then
            TARGET_REPO="${{ github.repository }}"
            MODE="enforce"
          elif [ "${{ github.event_name }}" = "schedule" ]; then
            TARGET_REPO="${{ github.repository }}"
            MODE="validate"
          else
            echo "::error::Unsupported trigger"
            exit 1
          fi

          OWNER="${TARGET_REPO%%/*}"
          TELEMETRY_REPO="${OWNER}/task-assistant-telemetry"

          echo "TARGET_REPO=$TARGET_REPO" >> $GITHUB_ENV
          echo "TARGET_OWNER=$OWNER" >> $GITHUB_ENV
          echo "TELEMETRY_REPO=$TELEMETRY_REPO" >> $GITHUB_ENV
          echo "MODE=$MODE" >> $GITHUB_ENV

          echo "Resolved:"
          echo "  target_repo=$TARGET_REPO"
          echo "  mode=$MODE"
          echo "  telemetry_repo=$TELEMETRY_REPO"

      # ─────────────────────────────────────────────
      # Dispatch → Engine: Self-Test
      # ─────────────────────────────────────────────
      - name: Run Self-Test Engine
        if: env.MODE == 'self-test'
        uses: ./.github/workflows/engine-self-test.yml
        with:
          target_repo: ${{ env.TARGET_REPO }}
          telemetry_repo: ${{ env.TELEMETRY_REPO }}
          correlation_id: ${{ env.CORRELATION_ID }}

      # ─────────────────────────────────────────────
      # Dispatch → Engine: Validate
      # ─────────────────────────────────────────────
      - name: Run Validate Engine
        if: env.MODE == 'validate'
        uses: ./.github/workflows/engine-validate.yml
        with:
          target_repo: ${{ env.TARGET_REPO }}
          telemetry_repo: ${{ env.TELEMETRY_REPO }}
          correlation_id: ${{ env.CORRELATION_ID }}

      # ─────────────────────────────────────────────
      # Dispatch → Engine: Enforce
      # ─────────────────────────────────────────────
      - name: Run Enforce Engine
        if: env.MODE == 'enforce'
        uses: ./.github/workflows/engine-enforce.yml
        with:
          target_repo: ${{ env.TARGET_REPO }}
          telemetry_repo: ${{ env.TELEMETRY_REPO }}
          correlation_id: ${{ env.CORRELATION_ID }}
