---
name: Task Assistant â€¢ Dispatch

# yamllint disable rule:truthy
on:
  workflow_dispatch:
    inputs:
      target_repo:
        description: "Target repository (owner/repo)"
        required: true
      mode:
        description: "Execution mode"
        required: true
        default: "self-test"
        type: choice
        options:
          - self-test
          - validate
          - enforce

  issues:
    types: [labeled]

  schedule:
    - cron: "0 3 * * *"

permissions:
  contents: write
  issues: write
  id-token: write

env:
  CORRELATION_ID: ${{ github.run_id }}-${{ github.run_attempt }}

jobs:
  resolve:
    runs-on: ubuntu-latest
    outputs:
      target_repo: ${{ steps.ctx.outputs.target_repo }}
      telemetry_repo: ${{ steps.ctx.outputs.telemetry_repo }}
      mode: ${{ steps.ctx.outputs.mode }}
    steps:
      - id: ctx
        run: |
          set -euo pipefail

          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            TARGET_REPO="${{ inputs.target_repo }}"
            MODE="${{ inputs.mode }}"
          elif [ "${{ github.event_name }}" = "issues" ]; then
            TARGET_REPO="${{ github.repository }}"
            MODE="enforce"
          else
            TARGET_REPO="${{ github.repository }}"
            MODE="validate"
          fi

          OWNER="${TARGET_REPO%%/*}"
          TELEMETRY_REPO="${OWNER}/task-assistant-telemetry"

          echo "target_repo=$TARGET_REPO" >> $GITHUB_OUTPUT
          echo "telemetry_repo=$TELEMETRY_REPO" >> $GITHUB_OUTPUT
          echo "mode=$MODE" >> $GITHUB_OUTPUT

  self_test:
    if: needs.resolve.outputs.mode == 'self-test'
    needs: resolve
    uses: ./.github/workflows/engine-self-test.yml
    with:
      target_repo: ${{ needs.resolve.outputs.target_repo }}
      telemetry_repo: ${{ needs.resolve.outputs.telemetry_repo }}
      correlation_id: ${{ env.CORRELATION_ID }}

  validate:
    if: needs.resolve.outputs.mode == 'validate'
    needs: resolve
    uses: ./.github/workflows/engine-validate.yml
    with:
      target_repo: ${{ needs.resolve.outputs.target_repo }}
      telemetry_repo: ${{ needs.resolve.outputs.telemetry_repo }}
      correlation_id: ${{ env.CORRELATION_ID }}

  enforce:
    if: needs.resolve.outputs.mode == 'enforce'
    needs: resolve
    uses: ./.github/workflows/engine-enforce.yml
    with:
      target_repo: ${{ needs.resolve.outputs.target_repo }}
      telemetry_repo: ${{ needs.resolve.outputs.telemetry_repo }}
      correlation_id: ${{ env.CORRELATION_ID }}
