---
name: Release â€¢ Pre-Tag Gate

# yamllint disable rule:truthy
on:
  workflow_dispatch:
    inputs:
      release_tag:
        description: "Tag to validate (e.g. v0.3.5)"
        required: true
        type: string

permissions:
  contents: read

jobs:
  validate-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate tag format
        run: |
          set -euo pipefail

          TAG="${{ inputs.release_tag }}"

          if ! [[ "$TAG" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "âŒ Invalid tag format. Must match vX.Y.Z"
            exit 1
          fi

          echo "âœ“ Tag format valid"

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Engine Governance Check
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Enforce engine governance
        run: |
          set -euo pipefail

          if grep -R "ref:[[:space:]]*main" .github/workflows; then
            echo "âŒ ref: main found in workflows"
            exit 1
          fi

          if grep -R "@phase-" .github/workflows; then
            echo "âŒ Branch engine refs detected. Must pin immutable tag before release."
            exit 1
          fi

          echo "âœ“ Engine governance validated"

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Telemetry Schema Lock Check
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Ensure telemetry schema unchanged
        run: |
          set -euo pipefail

          git fetch origin main

          if git diff --name-only origin/main -- docs/telemetry/schema-v1.0.md | grep -q .; then
            echo "âŒ Telemetry schema changed without version bump"
            exit 1
          fi

          echo "âœ“ Telemetry schema unchanged"

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Validator must pass on sample data
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Install dependencies
        run: |
          set -euo pipefail
          npm ci

      - name: Validate telemetry directory (if present)
        run: |
          set -euo pipefail

          if [[ -d "telemetry" ]]; then
            echo "Running telemetry validator..."
            node scripts/validate-telemetry.js
          else
            echo "No telemetry directory present (acceptable)"
          fi

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Dashboard reducer smoke test
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Dashboard reducer smoke test
        run: |
          set -euo pipefail

          export TELEMETRY_ROOT="./telemetry/v1/repos"

          if [[ -d "$TELEMETRY_ROOT" ]]; then
            echo "Running dashboard reducer smoke test..."
            node scripts/build-dashboards.js "$(ls "$TELEMETRY_ROOT" | head -n1)" >/dev/null || {
              echo "âŒ Dashboard reducer failed"
              exit 1
            }
          else
            echo "No telemetry present for reducer test (acceptable)"
          fi

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Confirm dispatch pinned to release tag
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Ensure dispatch pins immutable tag
        run: |
          set -euo pipefail

          TAG="${{ inputs.release_tag }}"

          if ! grep -R "@$TAG" .github/workflows/task-assistant-dispatch.yml >/dev/null; then
            echo "âŒ Dispatch not pinned to release tag $TAG"
            exit 1
          fi

          echo "âœ“ Dispatch pinned correctly"

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Success
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Release gate passed
        run: echo "ğŸ‰ Release validation passed â€” safe to tag."
