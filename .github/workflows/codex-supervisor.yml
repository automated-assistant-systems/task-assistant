---
# yamllint disable rule:truthy
name: Codex Supervisor

on:
  issues:
    types:
      - opened
      - edited
      - labeled
  issue_comment:
    types:
      - created

permissions:
  contents: write
  issues: write
  pull-requests: write

env:
  TELEMETRY_REPO: ${{ vars.TELEMETRY_REPO }}

jobs:
  intent-check:
    name: Evaluate Codex Intent
    runs-on: ubuntu-latest
    outputs:
      execute: ${{ steps.intent.outputs.execute }}
      reason: ${{ steps.intent.outputs.reason }}
    steps:
      - name: Determine execution intent
        id: intent
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            if (!issue) {
              core.setOutput("execute", "false");
              core.setOutput("reason", "not-an-issue-event");
              return;
            }

            const labels = issue.labels.map(l => l.name);
            const hasExecuteLabel = labels.includes("codex:execute");

            const commentBody = context.payload.comment?.body || "";
            const hasSlashCommand =
              commentBody.trim().startsWith("/codex execute");

            if (hasExecuteLabel || hasSlashCommand) {
              core.setOutput("execute", "true");
              core.setOutput("reason", "explicit-intent");
            } else {
              core.setOutput("execute", "false");
              core.setOutput("reason", "no-intent");
            }

  codex-run:
    name: Run Codex Task
    needs: intent-check
    if: needs.intent-check.outputs.execute == 'true'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate telemetry configuration
        run: |
          if [ -z "${TELEMETRY_REPO}" ]; then
            echo "❌ TELEMETRY_REPO is not configured"
            exit 1
          fi

      - name: Preflight – log issue context
        env:
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          REPO: ${{ github.repository }}
        run: |
          echo "Starting Codex execution for issue #${ISSUE_NUMBER}"
          gh issue view "${ISSUE_NUMBER}" \
            --repo "${REPO}" \
            --json body \
            | jq -r '.body'

      - name: Start Codex execution
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          CODEX_APP_ID: ${{ secrets.CODEX_APP_ID }}
          CODEX_PRIVATE_KEY: ${{ secrets.CODEX_PRIVATE_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TELEMETRY_REPO: ${{ vars.TELEMETRY_REPO }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          REPO: ${{ github.repository }}
          ISSUE_URL: ${{ github.event.issue.html_url }}
        run: |
          echo "Starting Codex execution for issue #${ISSUE_NUMBER}"
          echo "Repository: ${REPO}"
          echo "Issue URL: ${ISSUE_URL}"

          node scripts/codex/run.js \
            --repo "${{ github.repository }}" \
            --issue "${{ github.event.issue.number }}"

  no-op:
    name: No Codex Action Required
    needs: intent-check
    if: needs.intent-check.outputs.execute == 'false'
    runs-on: ubuntu-latest
    steps:
      - name: Exit cleanly
        run: |
          echo "ℹ️ No Codex intent detected."
          echo "Reason: ${{ needs.intent-check.outputs.reason }}"
