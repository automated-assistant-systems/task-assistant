---
# yamllint disable rule:truthy
name: Codex Supervisor

on:
  issues:
    types:
      - opened
      - edited
      - labeled
  issue_comment:
    types:
      - created

permissions:
  contents: write
  issues: write
  pull-requests: write

env:
  TELEMETRY_REPO: ${{ vars.TELEMETRY_REPO }}

jobs:
  intent-check:
    name: Evaluate Codex Intent
    runs-on: ubuntu-latest
    outputs:
      execute: ${{ steps.intent.outputs.execute }}
      reason: ${{ steps.intent.outputs.reason }}
    steps:
      - name: Determine execution intent (edge-gated)
        id: intent
        uses: actions/github-script@v7
        with:
          script: |
            const event = context.eventName;
            const action = context.payload.action;

            // Only explicit edges may execute
            const isLabelEdge =
              event === "issues" &&
              action === "labeled" &&
              context.payload.label?.name === "codex:execute";

            const isSlashCommand =
              event === "issue_comment" &&
              action === "created" &&
              (context.payload.comment?.body || "")
                .trim()
                .startsWith("/codex execute");

            if (isLabelEdge || isSlashCommand) {
              core.setOutput("execute", "true");
              core.setOutput(
                "reason",
                isLabelEdge ? "label-edge" : "slash-command"
              );
            } else {
              core.setOutput("execute", "false");
              core.setOutput("reason", "non-executable-event");
            }

  codex-run:
    name: Run Codex Task
    needs: intent-check
    if: needs.intent-check.outputs.execute == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Consume Codex intent
        run: |
          gh issue edit "${ISSUE_NUMBER}" \
            --repo "${REPO}" \
            --remove-label "codex:execute" || true
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          REPO: ${{ github.repository }}

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate telemetry configuration
        run: |
          if [ -z "${TELEMETRY_REPO}" ]; then
            echo "❌ TELEMETRY_REPO is not configured"
            exit 1
          fi

      - name: Preflight – log issue context
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          REPO: ${{ github.repository }}
        run: |
          echo "Starting Codex execution for issue #${ISSUE_NUMBER}"
          gh issue view "${ISSUE_NUMBER}" \
            --repo "${REPO}" \
            --json body \
            | jq -r '.body'

      - name: Start Codex execution
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          CODEX_APP_ID: ${{ secrets.CODEX_APP_ID }}
          CODEX_PRIVATE_KEY: ${{ secrets.CODEX_PRIVATE_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TELEMETRY_REPO: ${{ vars.TELEMETRY_REPO }}
          TELEMETRY_BRANCH: main
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          REPO: ${{ github.repository }}
          ISSUE_URL: ${{ github.event.issue.html_url }}
        run: |
          echo "Starting Codex execution for issue #${ISSUE_NUMBER}"
          echo "Repository: ${REPO}"
          echo "Issue URL: ${ISSUE_URL}"

          node scripts/codex/run.js \
            --repo "${{ github.repository }}" \
            --issue "${{ github.event.issue.number }}"

  no-op:
    name: No Codex Action Required
    needs: intent-check
    if: needs.intent-check.outputs.execute == 'false'
    runs-on: ubuntu-latest
    steps:
      - name: Exit cleanly
        run: |
          echo "ℹ️ No Codex intent detected."
          echo "Reason: ${{ needs.intent-check.outputs.reason }}"
