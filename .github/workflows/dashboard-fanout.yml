---
name: Task Assistant • Dashboard • Fanout Scheduler

# yamllint disable rule:truthy
on:
  schedule:
    - cron: "0 2 * * *"

  workflow_dispatch:
    inputs:
      correlation_id:
        description: "Optional correlation override (normally auto-generated)"
        required: false
        type: string

permissions:
  contents: read
  id-token: write

jobs:
  # ─────────────────────────────────────────────
  # Controller: read registry + emit matrix
  # ─────────────────────────────────────────────
  resolve:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.matrix.outputs.matrix }}
      correlation_id: ${{ steps.matrix.outputs.correlation_id }}

    steps:
      - uses: actions/checkout@v4
        with:
          repository: automated-assistant-systems/task-assistant-infra
          path: infra

      - id: matrix
        run: |
          set -euo pipefail

          CORRELATION_ID="${GITHUB_RUN_ID}-${GITHUB_RUN_ATTEMPT}"

          MATRIX=$(jq -c '
            .organizations[]
            | select(.dashboard.enabled == true)
            | {
                owner: .owner,
                telemetry_repo: .telemetry_repo
              }
          ' infra/telemetry-registry.json | jq -s '{ include: . }')

          echo "matrix=$MATRIX" >> "$GITHUB_OUTPUT"
          echo "correlation_id=$CORRELATION_ID" >> "$GITHUB_OUTPUT"

  # ─────────────────────────────────────────────
  # Fan-out: one job per org
  # ─────────────────────────────────────────────
  dashboard:
    needs: resolve
    strategy:
      fail-fast: false
      matrix: ${{ fromJSON(needs.resolve.outputs.matrix) }}

    uses: automated-assistant-systems/task-assistant/.github/workflows/engine-dashboard.yml@main
    with:
      owner:          ${{ matrix.owner }}
      telemetry_repo: ${{ matrix.telemetry_repo }}
      correlation_id: ${{ needs.resolve.outputs.correlation_id }}
    secrets:
      CODEX_APP_ID:      ${{ secrets.CODEX_APP_ID }}
      CODEX_PRIVATE_KEY: ${{ secrets.CODEX_PRIVATE_KEY }}
