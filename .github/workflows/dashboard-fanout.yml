---
name: Task Assistant • Dashboard • Fanout Scheduler

# yamllint disable rule:truthy
on:
  schedule:
    - cron: "0 2 * * *"
  workflow_dispatch:

permissions:
  contents: write
  id-token: write

jobs:
  resolve:
    runs-on: ubuntu-latest
    outputs:
      matrix:         ${{ steps.matrix.outputs.matrix }}
      correlation_id: ${{ steps.matrix.outputs.correlation_id }}

    steps:
      - name: Checkout infra registry
        uses: actions/checkout@v4
        with:
          repository: automated-assistant-systems/task-assistant-infra
          path: infra

      - name: Build dashboard matrix from infra
        id: matrix
        shell: bash
        run: |
          set -euo pipefail

          CORRELATION_ID="${GITHUB_RUN_ID}-${GITHUB_RUN_ATTEMPT}"

          # Validate registry shape
          jq -e '
            .organizations
            | type == "array"
            and all(
              .[]?;
              has("owner")
              and has("telemetry_repo")
              and has("dashboard")
              and .dashboard | has("enabled")
            )
          ' infra/telemetry-registry.json >/dev/null

          # Enforce owner-scoped telemetry repos
          jq -e '
            .organizations[]
            | select(.dashboard.enabled == true)
            | (.telemetry_repo | startswith(.owner + "/"))
          ' infra/telemetry-registry.json >/dev/null

          MATRIX=$(jq -c '
            [
              .organizations[]
              | select(.dashboard.enabled == true)
              | {
                  owner: .owner,
                  telemetry_repo: .telemetry_repo
                }
            ] as $items
            | { include: ($items // []) }
          ' infra/telemetry-registry.json)

          echo "matrix=$MATRIX" >> "$GITHUB_OUTPUT"
          echo "correlation_id=$CORRELATION_ID" >> "$GITHUB_OUTPUT"

  dashboard:
    needs: resolve
    if: ${{ fromJSON(needs.resolve.outputs.matrix).include != [] }}
    strategy:
      fail-fast: false
      matrix: ${{ fromJSON(needs.resolve.outputs.matrix) }}

    uses: automated-assistant-systems/task-assistant/.github/workflows/engine-dashboard.yml@main
    with:
      owner:          ${{ matrix.owner }}
      telemetry_repo: ${{ matrix.telemetry_repo }}
      correlation_id: ${{ needs.resolve.outputs.correlation_id }}
    secrets:
      CODEX_APP_ID:      ${{ secrets.CODEX_APP_ID }}
      CODEX_PRIVATE_KEY: ${{ secrets.CODEX_PRIVATE_KEY }}
