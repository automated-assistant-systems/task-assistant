---
name: Task Assistant • Dashboard • Fanout

# yamllint disable rule:truthy
on:
  workflow_dispatch:
  schedule:
    - cron: "0 4 * * *"

permissions:
  contents: write
  id-token: write

jobs:
  fanout:
    runs-on: ubuntu-latest

    env:
      ENGINE_NAME: dashboard
      ENGINE_JOB: fanout
      ENGINE_REF: phase-3.5

    steps:
      - name: Checkout Task Assistant
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: |
          set -euo pipefail
          npm ci

      - name: Generate GitHub App token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.CODEX_APP_ID }}
          private-key: ${{ secrets.CODEX_PRIVATE_KEY }}

      - name: Generate correlation ID
        run: |
          set -euo pipefail
          echo "CORRELATION_ID=${GITHUB_RUN_ID}-${GITHUB_RUN_ATTEMPT}" >> "$GITHUB_ENV"

      - name: Resolve dashboard fanout plan
        env:
          GITHUB_TOKEN: ${{ steps.app-token.outputs.token }}
        run: |
          set -euo pipefail

          node -e '
            import { listDashboardEligibleRepos } from "./lib/infra.js";
            const plan = await listDashboardEligibleRepos({
              githubToken: process.env.GITHUB_TOKEN,
              allowV1Fallback: true
            });
            if (!Array.isArray(plan)) {
              console.error("Fanout plan invalid");
              process.exit(1);
            }
            console.log(JSON.stringify(plan, null, 2));
          ' > fanout-plan.json

          jq -e 'type == "array"' fanout-plan.json >/dev/null

      - name: Trigger dashboard builds
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
        run: |
          set -euo pipefail

          COUNT="$(jq length fanout-plan.json)"

          if [[ "$COUNT" -eq 0 ]]; then
            echo "ℹ️ No dashboards to build"
            exit 0
          fi

          jq -c '.[]' fanout-plan.json | while read -r row; do
            OWNER="$(echo "$row" | jq -r '.owner')"
            REPO="$(echo "$row" | jq -r '.repo')"
            TELEMETRY_REPO="$(echo "$row" | jq -r '.telemetryRepo')"

            echo "→ Triggering dashboard build for $OWNER/$REPO"

            gh workflow run engine-dashboard.yml \
              --repo "${GITHUB_REPOSITORY}" \
              -f engine_ref="$ENGINE_REF" \
              -f owner="$OWNER" \
              -f repo="$REPO" \
              -f telemetry_repo="$TELEMETRY_REPO" \
              -f correlation_id="$CORRELATION_ID"
          done
