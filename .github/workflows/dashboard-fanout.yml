---
name: Task Assistant • Dashboard • Fanout

# yamllint disable rule:truthy
on:
  workflow_call:
    inputs:
      correlation_id:
        required: true
        type: string

    secrets:
      CODEX_APP_ID:
        required: true
      CODEX_PRIVATE_KEY:
        required: true

  workflow_dispatch: {}

  schedule:
    - cron: "0 4 * * *"

permissions:
  contents: write
  id-token: write

jobs:
  fanout:
    runs-on: ubuntu-latest

    env:
      ENGINE_NAME: dashboard
      ENGINE_JOB: fanout

    steps:
      - name: Checkout Task Assistant
        uses: actions/checkout@v4
        with:
          repository: automated-assistant-systems/task-assistant
          ref: main
          path: task-assistant

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        working-directory: task-assistant
        run: |
          set -euo pipefail
          npm ci

      # ─────────────────────────────────────────────
      # Generate GitHub App token (infra access)
      # ─────────────────────────────────────────────
      - name: Generate GitHub App token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id:      ${{ secrets.CODEX_APP_ID }}
          private-key: ${{ secrets.CODEX_PRIVATE_KEY }}

      # ─────────────────────────────────────────────
      # Generate Correlation ID
      # ─────────────────────────────────────────────
      - name: Generate correlation ID
        id: correlation
        run: |
          set -euo pipefail
          CORRELATION_ID="${GITHUB_RUN_ID}-${GITHUB_RUN_ATTEMPT}"
          echo "CORRELATION_ID=$CORRELATION_ID" >> "$GITHUB_ENV"

      # ─────────────────────────────────────────────
      # Enumerate dashboard-eligible repos from infra
      # ─────────────────────────────────────────────
      - name: Resolve dashboard fanout plan
        id: plan
        env:
          GITHUB_TOKEN: ${{ steps.app-token.outputs.token }}
        working-directory: task-assistant
        run: |
          set -euo pipefail

          cat > resolve-dashboard-fanout.mjs <<'JS'
          import fs from "fs";
          import { listDashboardEligibleRepos } from "./lib/infra.js";

          const plan = await listDashboardEligibleRepos({
            githubToken: process.env.GITHUB_TOKEN,
            allowV1Fallback: true
          });

          if (!Array.isArray(plan) || plan.length === 0) {
            console.log("ℹ️ No dashboard-eligible repos found");
            fs.writeFileSync("fanout-plan.json", "[]");
            process.exit(0);
          }

          console.log("Dashboard fanout plan:");
          console.log(JSON.stringify(plan, null, 2));

          fs.writeFileSync(
            "fanout-plan.json",
            JSON.stringify(plan, null, 2)
          );
          JS

          node resolve-dashboard-fanout.mjs

      # ─────────────────────────────────────────────
      # Trigger dashboard build per repo
      # ─────────────────────────────────────────────
      - name: Trigger dashboard builds
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
        run: |
          set -euo pipefail

          COUNT="$(jq length task-assistant/fanout-plan.json)"

          if [[ "$COUNT" -eq 0 ]]; then
            echo "ℹ️ No dashboards to build"
            exit 0
          fi

          for row in $(jq -c '.[]' task-assistant/fanout-plan.json); do
            OWNER="$(echo "$row" | jq -r '.owner')"
            REPO="$(echo "$row" | jq -r '.repo')"
            TELEMETRY_REPO="$(echo "$row" | jq -r '.telemetryRepo')"

            echo "→ Triggering dashboard build for $OWNER/$REPO"

            gh workflow run engine-dashboard.yml \
              --repo automated-assistant-systems/task-assistant \
              -f owner="$OWNER" \
              -f repo="$REPO" \
              -f telemetry_repo="$TELEMETRY_REPO" \
              -f correlation_id="$CORRELATION_ID"

          done

      - name: Export fanout context
        run: |
          echo "OWNER=infra" >> "$GITHUB_ENV"
          echo "REPO=dashboard-fanout" >> "$GITHUB_ENV"

      # ─────────────────────────────────────────────
      # Emit fanout telemetry (non-mutating)
      # ─────────────────────────────────────────────
      - name: Emit fanout telemetry
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
        working-directory: task-assistant
        run: |
          set -euo pipefail

          jq -n \
            --slurpfile plan fanout-plan.json \
            '{
              ok: true,
              engine: "dashboard-fanout",
              summary: "Dashboard fanout completed",
              dashboards_planned: ($plan[0] | length),
              plan: $plan[0]
            }' > result.json


          OWNER="$OWNER" \
          REPO="$REPO" \
          ENGINE_NAME="dashboard" \
          ENGINE_JOB="fanout" \
          RESULT_FILE="result.json" \
          ./scripts/telemetry/emit-engine.sh
