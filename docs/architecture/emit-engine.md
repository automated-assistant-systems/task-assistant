# Task Assistant — emit-engine Specification

Status: Canonical  
Audience: Core maintainers, engine authors, Marketplace reviewers  
Scope: Telemetry emission mechanism for all runtime engines  

---

## 1. Purpose

emit-engine is the single authorized mechanism for writing runtime telemetry.

All engines MUST emit exactly one telemetry record per invocation via emit-engine.

Engines are not permitted to write telemetry directly.

This guarantees:

- Canonical envelope structure
- Deterministic output
- Version traceability (engine_ref)
- Immutable audit records
- Single-record-per-engine enforcement

emit-engine centralizes observability authority.

---

## 2. Position in the Runtime Model

Runtime flow:

Dispatcher → Preflight → Engine → emit-engine → Telemetry Repository

emit-engine executes at the end of each engine run.

It is:

- Stateless
- Deterministic
- Append-only
- Version-aware

emit-engine does not perform engine logic.

---

## 3. Invocation Contract

emit-engine is invoked internally by each engine.

Inputs to emit-engine must include:

- engine_name
- engine_ref
- correlation_id
- target_repo
- telemetry_repo
- ok (true | false)
- details (engine-specific results)

Engines MUST NOT:

- Omit required envelope fields
- Modify correlation metadata
- Override engine_ref
- Write multiple telemetry records

---

## 4. Canonical Telemetry Envelope

emit-engine produces a JSON document with the following structure:

{
  "schema_version": "1.0",
  "generated_at": "UTC ISO-8601",
  "correlation_id": "...",
  "engine_name": "...",
  "engine_ref": "...",
  "source": "...",
  "entity": {...},
  "event": {...},
  "ok": true|false,
  "details": {...}
}

### Field Guarantees

schema_version  
- Locked version identifier for telemetry format.

generated_at  
- UTC ISO-8601 timestamp.
- Generated by emit-engine, not by the engine.

correlation_id  
- Dispatcher-provided.
- Immutable and opaque.

engine_name  
- Stable identifier of invoking engine.

engine_ref  
- Dispatcher-selected execution ref (tag or SHA).
- Included in every telemetry record.

ok  
- Boolean success indicator.
- Must reflect engine exit status.

details  
- Engine-specific result payload.
- Must not redefine identity fields.

---

## 5. Write Location

Telemetry is written exclusively to:

telemetry/v1/repos/<owner-repo>/<date>/<correlation_id>/

File name:

<engine_name>.json

Rules:

- Exactly one file per engine per correlation
- No overwrites
- No duplicates
- No writes to monitored repositories
- No writes outside telemetry_repo

---

## 6. Single-Record Guarantee

emit-engine enforces:

- Exactly one telemetry record per engine invocation
- Immutable write behavior
- No partial writes
- No secondary side-channel logs

If an engine attempts multiple emissions, behavior must fail safely.

---

## 7. Failure Semantics

### Engine Success
- ok=true
- Engine exits zero
- Telemetry written

### Engine Failure
- ok=false
- Engine exits non-zero
- Telemetry still written

emit-engine must execute even on failure paths.

### Transport Conflict (e.g. 409)
- Safe retry permitted
- Engine logic is not re-executed
- No duplicate records allowed

---

## 8. Determinism Requirements

emit-engine must be:

- Free of random behavior
- Free of time-based branching (aside from generated_at)
- Independent of runner state
- Independent of external artifacts

Given identical inputs, emit-engine must produce identical envelope structure.

---

## 9. Security Constraints

emit-engine:

- Uses GitHub App installation token
- Writes only to telemetry_repo
- Never escalates permissions
- Never writes to target_repo
- Never reads infra registries

It performs a single append-only write operation.

---

## 10. Prohibited Patterns

Engines must never:

- Directly call GitHub API to write telemetry
- Construct custom telemetry formats
- Write multiple telemetry files
- Modify previously written telemetry
- Write dashboards into monitored repositories

All telemetry authority flows through emit-engine.

---

## 11. Architectural Guarantees

emit-engine guarantees that:

- Telemetry format remains uniform
- engine_ref is always recorded
- Success and failure are explicitly represented
- Marketplace audit trails are reproducible
- Schema drift is prevented
- Cross-engine consistency is enforced

It is the single source of observability truth.

---

## Canonical Statement

emit-engine is the sole authorized telemetry emission mechanism in Task Assistant. It produces exactly one immutable, version-pinned telemetry record per engine invocation. Engines do not write telemetry directly. By centralizing envelope generation and write semantics, emit-engine guarantees determinism, auditability, and Marketplace-safe observability.
