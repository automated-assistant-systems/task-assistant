# Task Assistant — Telemetry Schema v1.0 (Authoritative)

Status: Locked  
Applies To: All engines emitting telemetry  
Effective Since: schema_version "1.0"  
Phase: 3.5 Hardening  

---

## 1. Purpose

This document defines the canonical telemetry contract for Task Assistant.

Telemetry events:

- Are deterministic
- Are append-only
- Are written as exactly one JSON object per engine file
- Must conform to this schema
- Must not drift without version change
- Must be emitted exclusively via emit-engine

Telemetry is the system’s durable audit log and governance backbone.

---

## 2. File Format

Encoding: UTF-8  
Format: Single JSON object per file  

Rules:

- Each engine execution produces exactly one JSON file
- Each file contains exactly one JSON object
- Files MUST NOT be appended to
- Files MUST NOT be overwritten
- Files MUST NOT contain multiple JSON records
- Engines MUST NOT write telemetry directly

Telemetry files are created exclusively via emit-engine.

---

## 3. Required Top-Level Envelope

Every telemetry record MUST contain:

{
"schema_version": "1.0",
"generated_at": "2026-02-05T01:16:34Z",
"correlation_id": "21694922610-1",
"engine_name": "preflight",
"engine_ref": "v0.3.5",
"source": { ... },
"entity": { ... },
"event": { ... },
"ok": true,
"details": { ... }
}

All fields are required unless otherwise specified.

---

## 3.1 Emission Authority (emit-engine)

All telemetry records MUST be produced via the shared emit-engine mechanism.

Engines MUST NOT:

- Manually construct telemetry envelopes
- Write telemetry directly via GitHub API
- Emit multiple telemetry records per invocation
- Omit required envelope fields
- Override engine_ref

emit-engine guarantees:

- Canonical envelope structure
- Inclusion of engine_ref
- Single-record-per-engine enforcement
- Immutable append-only behavior
- Standardized failure reporting

---

## 4. Field Definitions

### 4.1 schema_version

Type: string  
Required: Yes  
Value: "1.0"

Indicates telemetry schema version.  
Any structural change requires version bump.

---

### 4.2 generated_at

Type: string  
Format: ISO-8601 UTC timestamp  

Example:

2026-02-05T01:16:34Z  

Must always be UTC and include Z.  
Generated by emit-engine.

---

### 4.3 correlation_id

Type: string  
Required: Yes  

Used to group all engine emits belonging to a single dispatcher execution.

Rules:

- All engine events triggered by one dispatch MUST share the same correlation_id
- correlation_id MUST be non-null
- correlation_id MUST be deterministic within a dispatch
- Format is implementation-defined but must be string

---

### 4.4 engine_name

Type: string  
Required: Yes  

Stable identifier of the invoking engine.

Examples:

- preflight
- validate
- self-test
- enforce
- materialize
- dashboard

Must match event.category.

---

### 4.5 engine_ref

Type: string  
Required: Yes  

Dispatcher-selected execution ref (tag or SHA).

Rules:

- All engines in a dispatcher run MUST share the same engine_ref
- Floating branches are not permitted in Marketplace runtime
- engine_ref MUST be recorded exactly as provided

---

### 4.6 source

Describes where the event originated.

"source": {
"workflow": "engine-preflight",
"job": "preflight"
}


Required Fields:

| Field     | Type   | Description              |
|-----------|--------|--------------------------|
| workflow  | string | GitHub workflow name     |
| job       | string | GitHub job name          |

---

### 4.7 entity

Describes the primary subject of the event.

"entity": {
"type": "repository",
"owner": "garybayes",
"repo": "ta-sandbox"
}

Required Fields:

| Field | Type   | Description          |
|-------|--------|----------------------|
| type  | string | Currently "repository" |
| owner | string | Repository owner     |
| repo  | string | Repository name      |

Governance Rule:

entity.owner + entity.repo is canonical repository identity.  
Other repo references in details must not contradict this.

---

### 4.8 event

Describes the high-level outcome.

"event": {
"category": "preflight",
"action": "success",
"reason": null
}

Required Fields:

| Field    | Type             | Description              |
|----------|------------------|--------------------------|
| category | string           | Engine category          |
| action   | string           | High-level result        |
| reason   | string or null   | Explanation for failure  |

---

### 4.9 ok

Type: boolean  
Required: Yes  

Engine success indicator.

Rules:

- If ok = true → event.action MUST be "success"
- If ok = false → event.action MUST be "failure"
- If ok = false → event.reason MUST be non-null

Failure MUST NOT be represented solely by checks.

---

### 4.10 details

Type: object  
Required: Yes  

Contains engine-specific payload data.

Rules:

- Must be a JSON object
- Must not redefine top-level fields
- Must not duplicate event
- Must not redefine entity
- Must not overwrite engine_ref
- Must avoid naming collisions with top-level keys

---

## 5. Allowed Event Categories

Allowed in v1.0:

- preflight
- self-test
- materialize
- validate
- enforce
- dashboard
- release

Adding a new category does NOT require version bump.  
Removing or renaming does.

---

## 6. Allowed Event Actions

event.action MUST be:

- success
- failure

If action = "failure":

- reason MUST be non-null
- ok MUST be false

---

## 7. Validation Checks Structure (Optional)

When present:

"checks": [
{
"id": "config.load",
"outcome": "PASS",
"details": null
}
]


Allowed outcome values:

- PASS
- WARN
- FAIL

Checks provide diagnostic granularity.  
They do NOT override top-level action or ok.

---

## 8. Nested Event Naming Rule

Top-level key:

event

MUST NOT be reused inside details.

Example (correct):

"issue_event": {
"type": "labeled"
}


NOT:

"event": { ... }


Prevents flattening ambiguity.

---

## 9. Append-Only Guarantee

Telemetry files:

- Must never be rewritten
- Must never mutate prior records
- Must never reorder records
- Must never delete individual JSON files

Prune operations MAY delete:

- Entire <date>/ directories
- Entire <correlation_id>/ directories

Prune operations MUST be auditable.

---

## 10. Telemetry Repository Storage Layout (Authoritative)

Telemetry MUST be written to a dedicated telemetry repository.

Host repositories MUST NOT store telemetry.

### Root Path

telemetry/v1/

v1 corresponds to telemetry schema major version.

---

### Repository Partitioning

telemetry/v1/repos/<repo>/

Rules:

- <repo> MUST equal entity.repo
- Owner/org is implied by telemetry repository namespace

---

### Date Partitioning

telemetry/v1/repos/<repo>/<yyyy-mm-dd>/

Derived from generated_at (UTC).

---

### Correlation Partitioning

telemetry/v1/repos/<repo>/<yyyy-mm-dd>/<correlation_id>/

Directory name MUST equal correlation_id.

---

### Engine File Separation

telemetry/v1/repos/<repo>/<yyyy-mm-dd>/<correlation_id>/<category>.json

Rules:

- Filename MUST match event.category
- Exactly one file per engine execution
- Each file contains exactly one telemetry record
- emit-engine is the only mechanism allowed to create files
- No overwrites permitted

---

## 11. Backwards Compatibility Policy

Minor additions allowed without version bump:

- New optional fields in details
- New event categories
- New check IDs

Breaking changes require:

- schema_version increment
- New authoritative schema document
- Update to emit-engine specification

---

## 12. Governance Declaration

Telemetry Schema v1.0 is considered:

- Stable
- Production-ready
- Dashboard-safe
- Marketplace-safe
- Version-pinned
- Infrastructure-grade

Changes must be deliberate, versioned, and aligned with:

- architecture/runtime-model.md
- architecture/engine-interface.md
- architecture/emit-engine.md

